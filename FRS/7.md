# PH·∫¶N 7/10: FUNCTIONAL REQUIREMENTS - ANALYTICS, REPORTS & OFFLINE

````markdown
## 2.8 Ph√¢n t√≠ch & B√°o c√°o

### **FR-031: Analytics Dashboard - T·ªïng quan**

#### M√£ Ch·ª©c nƒÉng

`FR-031`

#### M√¥ t·∫£

Gi√°o vi√™n xem dashboard ph√¢n t√≠ch t·ªïng quan v·ªÅ sessions, goals, behaviors.

#### T√°c nh√¢n

- **Gi√°o vi√™n** (ƒë√£ ƒëƒÉng nh·∫≠p)

#### ƒêi·ªÅu ki·ªán Ti√™n quy·∫øt

- Gi√°o vi√™n ƒë√£ ƒëƒÉng nh·∫≠p
- (Optional) C√≥ √≠t nh·∫•t 1 session ƒë√£ completed

#### Lu·ªìng S·ª± ki·ªán Ch√≠nh

**B∆∞·ªõc 1:** Gi√°o vi√™n truy c·∫≠p m√†n h√¨nh "Ph√¢n t√≠ch"

**B∆∞·ªõc 2:** Gi√°o vi√™n ch·ªçn filters:

- **Student** (dropdown, default: All students)
- **Date range** (date picker, default: Last 30 days)

**B∆∞·ªõc 3:** H·ªá th·ªëng query data v·ªõi cache (Redis, TTL 5 ph√∫t):

**Query 1: Session Stats**

```sql
SELECT
  COUNT(*) AS total_sessions,
  COUNT(CASE WHEN status = 'completed' THEN 1 END) AS completed_sessions,
  COUNT(CASE WHEN status = 'pending' THEN 1 END) AS pending_sessions,
  COUNT(CASE WHEN status = 'cancelled' THEN 1 END) AS cancelled_sessions,
  AVG(duration_minutes) AS avg_duration
FROM sessions
WHERE created_by = :authenticated_teacher_id
  AND deleted_at IS NULL
  AND (:student_id IS NULL OR student_id = :student_id)
  AND session_date >= :date_from
  AND session_date <= :date_to;
```
````

**Query 2: Goal Achievement Stats**

```sql
SELECT
  COUNT(*) AS total_goals_evaluated,
  COUNT(CASE WHEN status = 'achieved' THEN 1 END) AS achieved,
  COUNT(CASE WHEN status = 'partially_achieved' THEN 1 END) AS partially_achieved,
  COUNT(CASE WHEN status = 'not_achieved' THEN 1 END) AS not_achieved,
  ROUND(AVG(achievement_level), 2) AS avg_achievement_level
FROM goal_evaluations ge
JOIN session_logs sl ON ge.session_log_id = sl.id
JOIN sessions s ON sl.session_id = s.id
WHERE s.created_by = :authenticated_teacher_id
  AND s.deleted_at IS NULL
  AND (:student_id IS NULL OR s.student_id = :student_id)
  AND s.session_date >= :date_from
  AND s.session_date <= :date_to;
```

**Query 3: Behavior Incidents Stats**

```sql
SELECT
  COUNT(*) AS total_incidents,
  COUNT(DISTINCT bi.behavior_library_id) AS unique_behaviors,
  ROUND(AVG(bi.intensity_level), 2) AS avg_intensity
FROM behavior_incidents bi
JOIN session_logs sl ON bi.session_log_id = sl.id
JOIN sessions s ON sl.session_id = s.id
WHERE s.created_by = :authenticated_teacher_id
  AND s.deleted_at IS NULL
  AND (:student_id IS NULL OR s.student_id = :student_id)
  AND s.session_date >= :date_from
  AND s.session_date <= :date_to;
```

**Query 4: Top 5 Behaviors**

```sql
SELECT
  bl.name_vn,
  bl.icon,
  bg.name_vn AS group_name,
  bg.color_code,
  COUNT(*) AS incident_count,
  ROUND(AVG(bi.intensity_level), 2) AS avg_intensity
FROM behavior_incidents bi
JOIN behavior_library bl ON bi.behavior_library_id = bl.id
JOIN behavior_groups bg ON bl.behavior_group_id = bg.id
JOIN session_logs sl ON bi.session_log_id = sl.id
JOIN sessions s ON sl.session_id = s.id
WHERE s.created_by = :authenticated_teacher_id
  AND s.deleted_at IS NULL
  AND (:student_id IS NULL OR s.student_id = :student_id)
  AND s.session_date >= :date_from
  AND s.session_date <= :date_to
GROUP BY bl.id, bl.name_vn, bl.icon, bg.name_vn, bg.color_code
ORDER BY incident_count DESC
LIMIT 5;
```

**Query 5: Trend Data (Sessions per week)**

```sql
SELECT
  DATE_TRUNC('week', session_date) AS week,
  COUNT(*) AS session_count,
  COUNT(CASE WHEN status = 'completed' THEN 1 END) AS completed_count
FROM sessions
WHERE created_by = :authenticated_teacher_id
  AND deleted_at IS NULL
  AND (:student_id IS NULL OR student_id = :student_id)
  AND session_date >= :date_from
  AND session_date <= :date_to
GROUP BY week
ORDER BY week;
```

**Query 6: Mood Trend**

```sql
SELECT
  s.session_date,
  sl.mood,
  sl.energy_level,
  sl.cooperation_level,
  sl.focus_level,
  sl.overall_rating
FROM session_logs sl
JOIN sessions s ON sl.session_id = s.id
WHERE s.created_by = :authenticated_teacher_id
  AND s.deleted_at IS NULL
  AND (:student_id IS NULL OR s.student_id = :student_id)
  AND s.session_date >= :date_from
  AND s.session_date <= :date_to
ORDER BY s.session_date;
```

**B∆∞·ªõc 4:** H·ªá th·ªëng cache k·∫øt qu·∫£ (Redis):

```javascript
const cacheKey = `analytics:${teacherId}:${studentId}:${dateFrom}:${dateTo}`;
await redis.setex(cacheKey, 300, JSON.stringify(data)); // TTL 5 min
```

**B∆∞·ªõc 5:** H·ªá th·ªëng tr·∫£ v·ªÅ data

**B∆∞·ªõc 6:** Client render dashboard v·ªõi:

- **Section 1: KPI Cards** - Total Sessions, Completion Rate, Avg Goal Achievement, Total Incidents
- **Section 2: Charts** - Line chart (trend), Bar chart (goals), Pie chart (status), Line chart (mood)
- **Section 3: Top 5 Behaviors** - List v·ªõi icon, name, count, avg intensity
- **Section 4: Recent Highlights** - Last 5 completed sessions

#### R√†ng bu·ªôc Nghi·ªáp v·ª•

| R√†ng bu·ªôc    | √Ånh x·∫° ERD  | M√¥ t·∫£                             |
| ------------ | ----------- | --------------------------------- |
| **RB-031-1** | Cache       | Redis cache v·ªõi TTL 5 ph√∫t        |
| **RB-031-2** | Performance | Query ph·∫£i < 500ms (v·ªõi indexes)  |
| **RB-031-3** | Filter      | Theo student_id, date_range       |
| **RB-031-4** | Aggregation | Complex JOINs qua multiple tables |

#### D·ªØ li·ªáu ƒê·∫ßu v√†o

```typescript
interface GetAnalyticsQuery {
  student_id?: string; // optional
  date_from: string; // YYYY-MM-DD, default: 30 days ago
  date_to: string; // YYYY-MM-DD, default: today
}
```

#### D·ªØ li·ªáu ƒê·∫ßu ra

**Success (200 OK):**

```json
{
  "success": true,
  "filters": {
    "student_id": null,
    "student_name": "T·∫•t c·∫£ h·ªçc sinh",
    "date_from": "2025-10-06",
    "date_to": "2025-11-05"
  },
  "kpis": {
    "total_sessions": 45,
    "completed_sessions": 40,
    "pending_sessions": 3,
    "cancelled_sessions": 2,
    "completion_rate": 88.9,
    "avg_duration_minutes": 85,
    "total_goals_evaluated": 320,
    "goal_achievement_rate": 76.5,
    "avg_achievement_level": 78.3,
    "total_incidents": 12,
    "unique_behaviors": 5,
    "avg_incident_intensity": 2.8
  },
  "charts": {
    "sessions_trend": [
      { "week": "2025-10-06", "session_count": 8, "completed_count": 7 },
      { "week": "2025-10-13", "session_count": 10, "completed_count": 9 }
    ],
    "goal_distribution": {
      "achieved": 245,
      "partially_achieved": 50,
      "not_achieved": 20,
      "not_applicable": 5
    },
    "mood_trend": [
      {
        "session_date": "2025-10-06",
        "mood": "good",
        "energy_level": 4,
        "cooperation_level": 5,
        "focus_level": 3,
        "overall_rating": 4
      }
    ]
  },
  "top_behaviors": [
    {
      "name_vn": "ƒÇn v·∫°",
      "icon": "üò≠",
      "group_name": "CH·ªêNG ƒê·ªêI & B∆Ø·ªöNG B·ªàNH",
      "color_code": "#FF5733",
      "incident_count": 5,
      "avg_intensity": 3.2
    }
  ]
}
```

#### API Endpoint

```
GET /api/analytics/overview?student_id=uuid&date_from=2025-10-06&date_to=2025-11-05
Authorization: Bearer <access_token>
```

#### Chart Rendering

S·ª≠ d·ª•ng library: **Recharts**, **Chart.js**, ho·∫∑c **Victory Native** (React Native)

#### ∆Øu ti√™n

**Must Have**

---

### **FR-032: Export Reports (PDF / Excel)**

#### M√£ Ch·ª©c nƒÉng

`FR-032`

#### M√¥ t·∫£

Gi√°o vi√™n export b√°o c√°o chi ti·∫øt d·∫°ng PDF ho·∫∑c Excel.

#### T√°c nh√¢n

- **Gi√°o vi√™n** (ƒë√£ ƒëƒÉng nh·∫≠p)

#### ƒêi·ªÅu ki·ªán Ti√™n quy·∫øt

- Gi√°o vi√™n ƒë√£ ƒëƒÉng nh·∫≠p
- C√≥ √≠t nh·∫•t 1 session completed

#### Lu·ªìng S·ª± ki·ªán Ch√≠nh

**B∆∞·ªõc 1:** Gi√°o vi√™n truy c·∫≠p "Ph√¢n t√≠ch" ho·∫∑c "Chi ti·∫øt H·ªçc sinh"

**B∆∞·ªõc 2:** Gi√°o vi√™n nh·∫•n "Xu·∫•t b√°o c√°o" ‚Üí ch·ªçn format:

- **PDF**: B√°o c√°o formatted, c√≥ charts, images
- **Excel**: Raw data, multiple sheets

**B∆∞·ªõc 3:** Gi√°o vi√™n ch·ªçn filters:

- Student (required cho individual report)
- Date range
- Report type: **Individual Student Report** ho·∫∑c **Summary Report**

**B∆∞·ªõc 4:** Gi√°o vi√™n submit

**B∆∞·ªõc 5:** H·ªá th·ªëng enqueue background job ƒë·ªÉ generate report

**B∆∞·ªõc 6:** H·ªá th·ªëng tr·∫£ v·ªÅ:

```json
{
  "success": true,
  "report_job_id": "job-uuid",
  "message": "ƒêang t·∫°o b√°o c√°o. B·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o khi ho√†n t·∫•t."
}
```

**B∆∞·ªõc 7:** Background worker x·ª≠ l√Ω:

**For PDF Report:**

**B∆∞·ªõc 7A:** Query t·∫•t c·∫£ data c·∫ßn thi·∫øt (sessions, logs, goals, behaviors)

**B∆∞·ªõc 7B:** Generate PDF s·ª≠ d·ª•ng library (e.g., **Puppeteer** ho·∫∑c **PDFKit**):

**PDF Structure:**

```
=== B√ÅO C√ÅO H·ªåC SINH ===
T√™n: Nguy·ªÖn VƒÉn An
Ng√†y sinh: 15/05/2018 (7 tu·ªïi)
Ch·∫©n ƒëo√°n: ASD Level 1
Th·ªùi gian: 06/10/2025 - 05/11/2025

--- T·ªîNG QUAN ---
‚Ä¢ T·ªïng s·ªë bu·ªïi h·ªçc: 12
‚Ä¢ Bu·ªïi ƒë√£ ho√†n th√†nh: 11 (91.7%)
‚Ä¢ T·ªïng s·ªë m·ª•c ti√™u: 88
‚Ä¢ M·ª•c ti√™u ƒë·∫°t ƒë∆∞·ª£c: 67 (76.1%)
‚Ä¢ S·ª± c·ªë h√†nh vi: 3

--- BI·ªÇU ƒê·ªí ---
[Goal Achievement Chart]
[Mood Trend Chart]
[Behavior Frequency Chart]

--- CHI TI·∫æT BU·ªîI H·ªåC ---
Bu·ªïi 1: 06/10/2025 - Nh·∫≠n bi·∫øt m√†u s·∫Øc
‚îú‚îÄ Th·ªùi gian: 09:00 - 10:30 (90 ph√∫t)
‚îú‚îÄ T√¢m tr·∫°ng: T·ªët üòÑ
‚îú‚îÄ M·ª•c ti√™u:
‚îÇ  ‚Ä¢ Tr·∫ª c√≥ th·ªÉ ch·ªâ ƒë√∫ng m√†u: ‚úÖ ƒê·∫°t (90%)
‚îÇ  ‚Ä¢ Tr·∫ª c√≥ th·ªÉ n√≥i t√™n m√†u: ‚ö†Ô∏è Ch∆∞a ƒë·∫°t ho√†n to√†n (60%)
‚îú‚îÄ Ghi ch√∫: Tr·∫ª ti·∫øn b·ªô r√µ r·ªát...
‚îî‚îÄ ·∫¢nh: [Embedded photos]

--- H√ÄNH VI ƒê·∫∂C BI·ªÜT ---
1. ƒÇn v·∫° (12/10/2025)
   ‚Ä¢ A: Gi√°o vi√™n y√™u c·∫ßu tr·∫ª d·ªçn ƒë·ªì ch∆°i
   ‚Ä¢ B: Tr·∫ª la h√©t, n√©m ƒë·ªì ch∆°i
   ‚Ä¢ C: Gi√°o vi√™n ph·ªõt l·ªù, tr·∫ª ng·ª´ng sau 3 ph√∫t
   ‚Ä¢ C∆∞·ªùng ƒë·ªô: 3/5

--- KHUY·∫æN NGH·ªä ---
‚Ä¢ Ti·∫øp t·ª•c luy·ªán t·∫≠p nh·∫≠n bi·∫øt m√†u s·∫Øc
‚Ä¢ TƒÉng c∆∞·ªùng k·ªπ nƒÉng giao ti·∫øp
```

**B∆∞·ªõc 7C:** Upload PDF l√™n R2: `reports/{teacher_id}/{timestamp}_report.pdf`

**For Excel Report:**

**B∆∞·ªõc 7E:** Query data

**B∆∞·ªõc 7F:** Generate Excel s·ª≠ d·ª•ng **ExcelJS**:

**Excel Structure:**

```
Sheet 1: T·ªïng quan - KPIs table
Sheet 2: Danh s√°ch Bu·ªïi h·ªçc - Session ID, Date, Time, Student, Status...
Sheet 3: Chi ti·∫øt M·ª•c ti√™u - Session Date, Content, Goal, Status, Achievement %...
Sheet 4: H√†nh vi - Session Date, Behavior, A-B-C, Intensity...
Sheet 5: Raw Data (optional) - All fields for advanced analysis
```

**B∆∞·ªõc 7G:** Upload Excel l√™n R2: `reports/{teacher_id}/{timestamp}_report.xlsx`

**B∆∞·ªõc 8:** Worker update job status v√† g·ª≠i notification

**B∆∞·ªõc 9:** Client nh·∫≠n notification v√† hi·ªÉn th·ªã link download

**B∆∞·ªõc 10:** Gi√°o vi√™n click download ‚Üí R2 signed URL (TTL 1 gi·ªù)

#### R√†ng bu·ªôc Nghi·ªáp v·ª•

| R√†ng bu·ªôc    | √Ånh x·∫° ERD         | M√¥ t·∫£                                   |
| ------------ | ------------------ | --------------------------------------- |
| **RB-032-1** | Background Job     | Async processing, kh√¥ng block UI        |
| **RB-032-2** | File Storage       | R2 v·ªõi signed URLs (TTL 1 gi·ªù)          |
| **RB-032-3** | Data Privacy       | Ch·ªâ teacher s·ªü h·ªØu data m·ªõi export ƒë∆∞·ª£c |
| **RB-032-4** | Performance Target | PDF: < 30s, Excel: < 15s                |
| **RB-032-5** | Charts in PDF      | Embed as images (PNG)                   |
| **RB-032-6** | Photos in PDF      | Compress v√† embed                       |

#### D·ªØ li·ªáu ƒê·∫ßu v√†o

```typescript
interface ExportReportInput {
  format: "pdf" | "excel";
  report_type: "individual" | "summary";
  student_id?: string; // required for 'individual'
  date_from: string;
  date_to: string;
}
```

#### D·ªØ li·ªáu ƒê·∫ßu ra

**Success (202 Accepted):**

```json
{
  "success": true,
  "report_job_id": "job-uuid",
  "estimated_time": "30 gi√¢y",
  "message": "ƒêang t·∫°o b√°o c√°o PDF. B·∫°n s·∫Ω nh·∫≠n ƒë∆∞·ª£c th√¥ng b√°o khi ho√†n t·∫•t."
}
```

**When job completes:**

```json
{
  "success": true,
  "report": {
    "id": "report-uuid",
    "format": "pdf",
    "file_url": "https://r2.../report.pdf?signed=...",
    "file_size": 2457600,
    "expires_at": "2025-11-05T08:34:18Z",
    "created_at": "2025-11-05T07:34:18Z"
  }
}
```

#### API Endpoints

```
POST /api/reports
GET /api/reports/:job_id
GET /api/reports/:job_id/download
Authorization: Bearer <access_token>
```

#### ∆Øu ti√™n

**Should Have**

---

## 2.9 ƒê·ªìng b·ªô Offline

### **FR-033: Offline Cache - Sync d·ªØ li·ªáu khi Online**

#### M√£ Ch·ª©c nƒÉng

`FR-033`

#### M√¥ t·∫£

H·ªá th·ªëng t·ª± ƒë·ªông cache d·ªØ li·ªáu quan tr·ªçng ƒë·ªÉ s·ª≠ d·ª•ng offline.

#### T√°c nh√¢n

- **Client App** (automated)

#### ƒêi·ªÅu ki·ªán Ti√™n quy·∫øt

- App ƒë√£ ƒëƒÉng nh·∫≠p
- K·∫øt n·ªëi internet available

#### Lu·ªìng S·ª± ki·ªán Ch√≠nh

**B∆∞·ªõc 1:** Khi app start ho·∫∑c khi c√≥ k·∫øt n·ªëi internet, client ki·ªÉm tra cache version

**B∆∞·ªõc 2:** Client g·ªçi API sync:

```
GET /api/sync/metadata
Authorization: Bearer <access_token>
```

**B∆∞·ªõc 3:** Server tr·∫£ v·ªÅ metadata:

```json
{
  "last_sync_at": "2025-11-04T10:00:00Z",
  "data_versions": {
    "students": "v123",
    "sessions": "v456",
    "behaviors": "v789"
  }
}
```

**B∆∞·ªõc 4:** Client so s√°nh v·ªõi local cache version

**B∆∞·ªõc 5:** N·∫øu outdated, client download data c·∫ßn thi·∫øt:

**Data to cache:**

1. **Student List** - `GET /api/students?all=true`
2. **Sessions (Last 30 days)** - `GET /api/sessions?date_from={30_days_ago}&limit=all`
3. **Behavior Library (Full)** - `GET /api/behaviors?limit=all`
4. **User Settings** - `GET /api/settings`

**B∆∞·ªõc 6:** Client l∆∞u data v√†o local database (SQLite):

**SQLite Schema:**

```sql
-- Local cache DB
CREATE TABLE cached_students (...);
CREATE TABLE cached_sessions (...);
CREATE TABLE cached_session_contents (...);
CREATE TABLE cached_content_goals (...);
CREATE TABLE cached_behaviors (...);
CREATE TABLE cached_behavior_groups (...);

-- Metadata
CREATE TABLE sync_metadata (
  entity TEXT PRIMARY KEY,
  last_sync_at TIMESTAMP,
  version TEXT
);
```

**B∆∞·ªõc 7:** Client update sync_metadata

**B∆∞·ªõc 8:** Client hi·ªÉn th·ªã toast: "D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c ƒë·ªìng b·ªô"

#### R√†ng bu·ªôc Nghi·ªáp v·ª•

| R√†ng bu·ªôc    | √Ånh x·∫° ERD     | M√¥ t·∫£                                                          |
| ------------ | -------------- | -------------------------------------------------------------- |
| **RB-033-1** | Local DB       | SQLite (React Native: `react-native-sqlite-storage`)           |
| **RB-033-2** | Cache Scope    | Students (all), Sessions (30 days), Behaviors (all)            |
| **RB-033-3** | Sync Frequency | Auto khi app start + manual refresh                            |
| **RB-033-4** | Data Size      | Estimate: ~5-10MB cho 50 students, 200 sessions, 127 behaviors |

#### API Endpoints

```
GET /api/sync/metadata
GET /api/students?all=true
GET /api/sessions?date_from=...&limit=all
GET /api/behaviors?limit=all
```

#### ∆Øu ti√™n

**Should Have**

---

### **FR-034: Offline Mode - Read-only Access**

#### M√£ Ch·ª©c nƒÉng

`FR-034`

#### M√¥ t·∫£

Khi offline, user c√≥ th·ªÉ xem (read-only) d·ªØ li·ªáu ƒë√£ cache.

#### T√°c nh√¢n

- **Gi√°o vi√™n** (offline)

#### ƒêi·ªÅu ki·ªán Ti√™n quy·∫øt

- ƒê√£ c√≥ cached data (t·ª´ FR-033)
- Kh√¥ng c√≥ k·∫øt n·ªëi internet

#### Lu·ªìng S·ª± ki·ªán Ch√≠nh

**B∆∞·ªõc 1:** App detect m·∫•t k·∫øt n·ªëi internet (NetInfo)

**B∆∞·ªõc 2:** App hi·ªÉn th·ªã banner: "‚ö†Ô∏è Ch·∫ø ƒë·ªô Offline - Ch·ªâ xem, kh√¥ng th·ªÉ ch·ªânh s·ª≠a"

**B∆∞·ªõc 3:** App switch sang query t·ª´ SQLite local DB

**Available offline features:**

- ‚úÖ Xem danh s√°ch students
- ‚úÖ Xem chi ti·∫øt student
- ‚úÖ Xem danh s√°ch sessions (30 days)
- ‚úÖ Xem chi ti·∫øt session (contents, goals)
- ‚úÖ Xem behavior library
- ‚úÖ Xem chi ti·∫øt behavior
- ‚ùå **KH√îNG** t·∫°o/s·ª≠a/x√≥a b·∫•t k·ª≥ d·ªØ li·ªáu n√†o
- ‚ùå **KH√îNG** ghi nh·∫≠t k√Ω
- ‚ùå **KH√îNG** upload media

**B∆∞·ªõc 4:** N·∫øu user c·ªë g·∫Øng create/edit, hi·ªÉn th·ªã toast:

```
"B·∫°n ƒëang offline. T√≠nh nƒÉng n√†y c·∫ßn k·∫øt n·ªëi internet."
```

**B∆∞·ªõc 5:** Khi c√≥ internet tr·ªü l·∫°i:

- App detect k·∫øt n·ªëi
- App t·ª± ƒë·ªông sync (FR-033)
- App remove offline banner
- Enable t·∫•t c·∫£ features

#### R√†ng bu·ªôc Nghi·ªáp v·ª•

| R√†ng bu·ªôc    | √Ånh x·∫° ERD     | M√¥ t·∫£                                          |
| ------------ | -------------- | ---------------------------------------------- |
| **RB-034-1** | Read-only      | T·∫•t c·∫£ write operations b·ªã disable khi offline |
| **RB-034-2** | UI Indicators  | Banner, disabled buttons, tooltips             |
| **RB-034-3** | Data Staleness | Hi·ªÉn th·ªã "Last synced: X minutes ago"          |

#### ∆Øu ti√™n

**Should Have**

---

### **FR-035: Offline Queue - Sync writes khi Online**

#### M√£ Ch·ª©c nƒÉng

`FR-035`

#### M√¥ t·∫£

User c√≥ th·ªÉ t·∫°o/s·ª≠a d·ªØ li·ªáu offline, h·ªá th·ªëng queue v√† sync khi online.

#### T√°c nh√¢n

- **Gi√°o vi√™n** (c√≥ th·ªÉ offline/online)

#### ƒêi·ªÅu ki·ªán Ti√™n quy·∫øt

- App ƒë√£ ƒëƒÉng nh·∫≠p

#### Lu·ªìng S·ª± ki·ªán Ch√≠nh

**B∆∞·ªõc 1:** User t·∫°o/s·ª≠a d·ªØ li·ªáu (v√≠ d·ª•: create session, log session)

**B∆∞·ªõc 2:** App ki·ªÉm tra internet:

**N·∫øu ONLINE:**

- G·ªçi API b√¨nh th∆∞·ªùng
- Save th√†nh c√¥ng

**N·∫øu OFFLINE:**

**B∆∞·ªõc 3:** App l∆∞u action v√†o **Offline Queue** (SQLite):

```sql
CREATE TABLE offline_queue (
  id TEXT PRIMARY KEY,
  action_type TEXT,  -- 'CREATE_SESSION', 'UPDATE_SESSION', 'CREATE_LOG'...
  entity_type TEXT,  -- 'sessions', 'session_logs'...
  entity_id TEXT,    -- local temp ID (uuid)
  payload TEXT,      -- JSON stringify
  status TEXT,       -- 'pending', 'syncing', 'success', 'failed'
  retry_count INTEGER DEFAULT 0,
  created_at TIMESTAMP,
  synced_at TIMESTAMP
);
```

**B∆∞·ªõc 4:** App l∆∞u d·ªØ li·ªáu v√†o local DB (v·ªõi temp ID)

**B∆∞·ªõc 5:** App hi·ªÉn th·ªã toast: "‚úÖ ƒê√£ l∆∞u offline. S·∫Ω ƒë·ªìng b·ªô khi c√≥ internet."

**B∆∞·ªõc 6:** Khi c√≥ internet tr·ªü l·∫°i:

**B∆∞·ªõc 7:** App detect k·∫øt n·ªëi

**B∆∞·ªõc 8:** App x·ª≠ l√Ω offline queue theo th·ª© t·ª± FIFO:

**V·ªõi m·ªói queued action:**

**B∆∞·ªõc 8A:** Update status = 'syncing'

**B∆∞·ªõc 8B:** G·ªçi API t∆∞∆°ng ·ª©ng:

```javascript
const action = queue[i];

switch (action.action_type) {
  case "CREATE_SESSION":
    response = await api.post("/api/sessions", JSON.parse(action.payload));
    break;
  case "UPDATE_SESSION":
    response = await api.patch(
      `/api/sessions/${action.entity_id}`,
      JSON.parse(action.payload)
    );
    break;
  // ...
}
```

**B∆∞·ªõc 8C:** N·∫øu success:

- Update queue status = 'success', synced_at = NOW()
- Update local DB record v·ªõi server ID (replace temp ID)

**B∆∞·ªõc 8D:** N·∫øu error:

- Retry v·ªõi exponential backoff (max 3 retries)
- N·∫øu v·∫´n fail: update status = 'failed', hi·ªÉn th·ªã notification

**Conflict Resolution:**

**Simple Strategy (Last-Write-Wins):**

- N·∫øu data ƒë√£ b·ªã update tr√™n server ‚Üí Server tr·∫£ error `409 Conflict`
- App hi·ªÉn th·ªã dialog: "D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª´ thi·∫øt b·ªã kh√°c. B·∫°n mu·ªën ghi ƒë√®?"
  - **Ghi ƒë√®**: Force update
  - **H·ªßy**: Discard local changes, fetch server data

**B∆∞·ªõc 9:** App hi·ªÉn th·ªã toast: "‚úÖ ƒê√£ ƒë·ªìng b·ªô t·∫•t c·∫£ thay ƒë·ªïi"

#### R√†ng bu·ªôc Nghi·ªáp v·ª•

| R√†ng bu·ªôc    | √Ånh x·∫° ERD          | M√¥ t·∫£                                                    |
| ------------ | ------------------- | -------------------------------------------------------- |
| **RB-035-1** | Queue Order         | FIFO (First-In-First-Out)                                |
| **RB-035-2** | Retry Logic         | Max 3 retries, exponential backoff (1s, 2s, 4s)          |
| **RB-035-3** | Conflict Resolution | Last-write-wins (simple), Manual merge (complex)         |
| **RB-035-4** | Temp IDs            | Client-generated UUIDs, replaced v·ªõi server IDs sau sync |

#### ∆Øu ti√™n

**Should Have** (nh∆∞ng ph·ª©c t·∫°p, c√≥ th·ªÉ gi·∫£m scope xu·ªëng Read-only offline)

---

```

**‚úÖ PH·∫¶N 7 XONG - Sections 2.8, 2.9 ho√†n t·∫•t**

Ti·∫øp t·ª•c v·ªõi **PH·∫¶N 8/10: SETTINGS, BACKUP, DELETE ACCOUNT (FR-036 ƒë·∫øn FR-038) + NON-FUNCTIONAL REQUIREMENTS**?
```
