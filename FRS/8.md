# PHẦN 8/10: FUNCTIONAL REQUIREMENTS - SETTINGS & BACKUP + NFRs

````markdown
## 2.10 Cài đặt & Sao lưu

### **FR-036: User Settings - Cập nhật Preferences**

#### Mã Chức năng

`FR-036`

#### Mô tả

Giáo viên cập nhật cài đặt cá nhân (timezone, language, notifications, ...).

#### Tác nhân

- **Giáo viên** (đã đăng nhập)

#### Điều kiện Tiên quyết

- Giáo viên đã đăng nhập

#### Luồng Sự kiện Chính

**Bước 1:** Giáo viên truy cập "Cài đặt"

**Bước 2:** Hệ thống hiển thị settings grouped by category:

**Category 1: Hồ sơ (Profile)**

- Avatar
- First name, Last name
- Email (read-only, có thể change bằng "Change email" flow riêng)
- Phone
- School
- Timezone (dropdown)
- Language (vi/en)

**Category 2: Bảo mật (Security)**

- Change password
- Enable 2FA (optional, Could Have)
- Biometric login (toggle)

**Category 3: Thông báo (Notifications)**

- Push notifications (toggle)
- Email notifications (toggle)
- Notification frequency (immediate/daily digest/weekly)

**Category 4: Giao diện (Appearance)**

- Theme (light/dark/auto)
- Font size (small/medium/large)

**Category 5: Dữ liệu (Data)**

- Auto-save interval (30s/1min/2min)
- Offline cache size (limit)
- Export data
- Delete account

**Bước 3:** Giáo viên thay đổi settings

**Bước 4:** Với mỗi setting change:

**For `TEACHERS` table fields:**

```sql
UPDATE teachers
SET
  first_name = :first_name,
  last_name = :last_name,
  phone = :phone,
  school = :school,
  avatar_url = :avatar_url,
  timezone = :timezone,
  language = :language,
  updated_at = NOW()
WHERE id = :authenticated_teacher_id;
```
````

**For other settings (stored in `USER_SETTINGS`):**

```sql
INSERT INTO user_settings (
  id,
  teacher_id,
  key,                     -- e.g., 'theme', 'push_notifications'...
  value,                   -- JSONB: { "enabled": true }
  created_at,
  updated_at
) VALUES (...)
ON CONFLICT (teacher_id, key)  -- UNIQUE constraint
DO UPDATE SET
  value = EXCLUDED.value,
  updated_at = NOW();
```

**Bước 5:** Hệ thống trả về success

**Bước 6:** Client apply settings (e.g., change theme, locale)

#### Ràng buộc Nghiệp vụ

| Ràng buộc    | Ánh xạ ERD                 | Mô tả                                                                        |
| ------------ | -------------------------- | ---------------------------------------------------------------------------- |
| **RB-036-1** | `TEACHERS` table           | Cơ bản: first_name, last_name, phone, school, avatar_url, timezone, language |
| **RB-036-2** | `USER_SETTINGS` table      | Key-value store cho advanced settings                                        |
| **RB-036-3** | `USER_SETTINGS.value`      | JSONB cho flexibility                                                        |
| **RB-036-4** | `UNIQUE (teacher_id, key)` | Mỗi teacher chỉ có 1 value per key                                           |

#### Dữ liệu Đầu vào

```typescript
interface UpdateSettingsInput {
  // Profile
  first_name?: string;
  last_name?: string;
  phone?: string;
  school?: string;
  avatar?: File;
  timezone?: string; // e.g., 'Asia/Ho_Chi_Minh'
  language?: "vi" | "en";

  // Other settings (stored in USER_SETTINGS)
  theme?: "light" | "dark" | "auto";
  font_size?: "small" | "medium" | "large";
  push_notifications?: boolean;
  email_notifications?: boolean;
  notification_frequency?: "immediate" | "daily" | "weekly";
}
```

#### Dữ liệu Đầu ra

**Success (200 OK):**

```json
{
  "success": true,
  "user": {
    "id": "uuid",
    "first_name": "Trần",
    "last_name": "Hảo",
    "email": "tranhaohcmus@...",
    "phone": "0901234567",
    "school": "Trường ABC",
    "timezone": "Asia/Ho_Chi_Minh",
    "language": "vi",
    "avatar_url": "https://...",
    "updated_at": "2025-11-05T07:38:00Z"
  },
  "settings": {
    "theme": "dark",
    "font_size": "medium",
    "push_notifications": true,
    "email_notifications": false
  }
}
```

#### API Endpoints

```
GET /api/settings
PATCH /api/settings
Authorization: Bearer <access_token>
```

#### Ưu tiên

**Must Have** (profile), **Should Have** (advanced settings)

---

### **FR-037: Data Backup & Export**

#### Mã Chức năng

`FR-037`

#### Mô tả

Giáo viên có thể backup và export toàn bộ dữ liệu của mình.

#### Tác nhân

- **Giáo viên** (đã đăng nhập)

#### Điều kiện Tiên quyết

- Giáo viên đã đăng nhập

#### Luồng Sự kiện Chính

**Bước 1:** Giáo viên truy cập "Cài đặt" → "Dữ liệu" → "Sao lưu & Xuất dữ liệu"

**Bước 2:** Giáo viên chọn loại backup:

- **Auto Backup**: Tự động hàng tuần
- **Manual Backup**: Tạo ngay bây giờ

**Bước 3:** Giáo viên nhấn "Tạo bản sao lưu"

**Bước 4:** Hệ thống enqueue background job

**Bước 5:** Background worker:

**Bước 5A:** Query tất cả data của teacher:

- Students
- Sessions (với contents, goals, logs, evaluations, media, incidents)
- Favorites
- Settings
- Content templates

**Bước 5B:** Generate ZIP file chứa:

```
backup_2025-11-05_07-38.zip
├── data.json           (All structured data)
├── media/
│   ├── students/
│   │   └── avatar_*.jpg
│   └── session-logs/
│       ├── photo_*.jpg
│       ├── video_*.mp4
│       └── audio_*.m4a
└── README.txt          (Hướng dẫn restore)
```

**data.json structure:**

```json
{
  "export_date": "2025-11-05T07:38:00Z",
  "teacher": {...},
  "students": [...],
  "sessions": [...],
  "session_logs": [...],
  "goal_evaluations": [...],
  "behavior_incidents": [...],
  "content_library": [...],
  "user_settings": {...}
}
```

**Bước 5C:** Upload ZIP lên R2: `backups/{teacher_id}/{timestamp}_backup.zip`

**Bước 5D:** Tạo record trong `BACKUP_HISTORY`:

```sql
INSERT INTO backup_history (
  id,
  teacher_id,
  backup_type,           -- 'manual' | 'auto'
  file_url,
  file_size,
  status,                -- 'pending' → 'completed'
  created_at
) VALUES (...);
```

**Bước 6:** Worker gửi notification cho giáo viên

**Bước 7:** Giáo viên download file ZIP (R2 signed URL, TTL 7 days)

**Auto Backup (Scheduled Job):**

**Bước A1:** Cron job chạy hàng tuần (ví dụ: Sunday 2 AM UTC)

**Bước A2:** Với mỗi teacher có `auto_backup_enabled = true` (setting):

- Trigger backup job (giống manual)

**Bước A3:** Keep tối đa 4 bản backup gần nhất, xóa backups cũ hơn

#### Ràng buộc Nghiệp vụ

| Ràng buộc    | Ánh xạ ERD             | Mô tả                                                  |
| ------------ | ---------------------- | ------------------------------------------------------ |
| **RB-037-1** | `BACKUP_HISTORY` table | Track backup history                                   |
| **RB-037-2** | File Format            | ZIP chứa JSON + media files                            |
| **RB-037-3** | Retention              | Keep max 4 backups gần nhất (auto-cleanup old backups) |
| **RB-037-4** | File Size              | Ước tính: 50-500MB tùy số lượng media                  |
| **RB-037-5** | Privacy                | Chỉ teacher sở hữu data mới backup/download được       |
| **RB-037-6** | GDPR Compliance        | Right to data portability (GDPR Article 20)            |

#### Dữ liệu Đầu vào

```typescript
interface CreateBackupInput {
  backup_type: "manual" | "auto";
  include_media?: boolean; // default true
}
```

#### Dữ liệu Đầu ra

**Success (202 Accepted):**

```json
{
  "success": true,
  "backup_job_id": "job-uuid",
  "message": "Đang tạo bản sao lưu. Bạn sẽ nhận được thông báo khi hoàn tất.",
  "estimated_time": "5-10 phút"
}
```

**When job completes:**

```json
{
  "success": true,
  "backup": {
    "id": "backup-uuid",
    "backup_type": "manual",
    "file_url": "https://r2.../backup.zip?signed=...",
    "file_size": 157286400, // ~150MB
    "expires_at": "2025-11-12T07:38:00Z", // 7 days
    "created_at": "2025-11-05T07:38:00Z"
  }
}
```

#### API Endpoints

```
POST /api/backups
GET /api/backups
GET /api/backups/:backup_id/download
Authorization: Bearer <access_token>
```

#### Ưu tiên

**Should Have**

---

### **FR-038: Delete Account (GDPR Right to Erasure)**

#### Mã Chức năng

`FR-038`

#### Mô tả

Giáo viên có thể xóa tài khoản và tất cả dữ liệu (GDPR compliance).

#### Tác nhân

- **Giáo viên** (đã đăng nhập)

#### Điều kiện Tiên quyết

- Giáo viên đã đăng nhập

#### Luồng Sự kiện Chính

**Bước 1:** Giáo viên truy cập "Cài đặt" → "Dữ liệu" → "Xóa tài khoản"

**Bước 2:** Hệ thống hiển thị warning dialog:

```
⚠️ CẢNH BÁO: Hành động này KHÔNG THỂ HOÀN TÁC!

Khi xóa tài khoản, tất cả dữ liệu sau sẽ bị xóa vĩnh viễn:
• Hồ sơ cá nhân
• Tất cả học sinh (X học sinh)
• Tất cả buổi học (Y buổi)
• Tất cả nhật ký và đánh giá
• Tất cả media (ảnh, video, audio)
• Tất cả cài đặt và preferences

Bạn có chắc chắn muốn tiếp tục?

[ ] Tôi hiểu và muốn xóa tài khoản

[Hủy]  [Xuất dữ liệu trước]  [Xóa tài khoản]
```

**Bước 3:** Giáo viên có thể:

- **Hủy**: Cancel
- **Xuất dữ liệu trước**: Trigger FR-037 backup trước khi xóa
- **Xóa tài khoản**: Tiếp tục

**Bước 4:** Nếu chọn "Xóa tài khoản", hệ thống yêu cầu re-authenticate:

```
Để xác nhận, vui lòng nhập mật khẩu của bạn:
[Password input]
[Xác nhận xóa]
```

**Bước 5:** Giáo viên nhập password và xác nhận

**Bước 6:** Hệ thống verify password

**Bước 7:** Hệ thống enqueue background job để xóa data

**Bước 8:** Hệ thống logout user ngay lập tức

**Bước 9:** Background worker thực hiện xóa theo thứ tự:

**Step 1: Xóa media files từ R2**

```javascript
// Delete all media for this teacher
const mediaFiles = await getMediaFilesByTeacher(teacherId);
for (const file of mediaFiles) {
  await r2.deleteObject(file.key);
}
```

**Step 2: Xóa backup files từ R2**

```javascript
const backupFiles = await getBackupsByTeacher(teacherId);
for (const file of backupFiles) {
  await r2.deleteObject(file.key);
}
```

**Step 3: Xóa data từ Database (CASCADE)**

**Thứ tự xóa (do FK constraints):**

```sql
-- Transaction START

-- 1. Xóa child records trước
DELETE FROM teacher_favorites WHERE teacher_id = :teacher_id;
DELETE FROM content_library_ratings WHERE teacher_id = :teacher_id;
DELETE FROM user_settings WHERE teacher_id = :teacher_id;
DELETE FROM backup_history WHERE teacher_id = :teacher_id;
DELETE FROM ai_processing WHERE teacher_id = :teacher_id;

-- 2. Xóa content_library (teacher's templates)
DELETE FROM content_library WHERE teacher_id = :teacher_id;

-- 3. Xóa students và CASCADE sẽ tự động xóa:
--    - sessions (ON DELETE CASCADE)
--    - session_contents (cascade từ sessions)
--    - content_goals (cascade từ session_contents)
--    - session_logs (cascade từ sessions)
--    - goal_evaluations (cascade từ session_logs)
--    - log_media_attachments (cascade từ session_logs)
--    - behavior_incidents (cascade từ session_logs)
DELETE FROM students WHERE teacher_id = :teacher_id;

-- 4. Cuối cùng xóa teacher
DELETE FROM teachers WHERE id = :teacher_id;

-- Transaction COMMIT
```

**Lưu ý về CASCADE trong ERD:**

Theo ERD, các FK có `ON DELETE CASCADE`:

- `STUDENTS.teacher_id` → cascade xóa STUDENTS
- `SESSIONS.student_id` → cascade xóa SESSIONS
- `SESSION_CONTENTS.session_id` → cascade xóa CONTENTS
- `CONTENT_GOALS.session_content_id` → cascade xóa GOALS
- `SESSION_LOGS.session_id` → cascade xóa LOGS
- `GOAL_EVALUATIONS.session_log_id` → cascade xóa EVALUATIONS
- `LOG_MEDIA_ATTACHMENTS.session_log_id` → cascade xóa MEDIA RECORDS
- `BEHAVIOR_INCIDENTS.session_log_id` → cascade xóa INCIDENTS

**Bước 10:** Worker gửi email confirmation:

```
Subject: Xác nhận xóa tài khoản - Educare Connect

Xin chào [Teacher Name],

Tài khoản của bạn đã được xóa thành công vào 2025-11-05 07:38:00 UTC.

Tất cả dữ liệu của bạn đã được xóa vĩnh viễn khỏi hệ thống.

Nếu bạn không thực hiện hành động này, vui lòng liên hệ support ngay lập tức.

Cảm ơn bạn đã sử dụng Educare Connect.
```

**Bước 11:** Cleanup tokens (blacklist all refresh tokens)

#### Ràng buộc Nghiệp vụ

| Ràng buộc    | Ánh xạ ERD        | Mô tả                                                   |
| ------------ | ----------------- | ------------------------------------------------------- |
| **RB-038-1** | GDPR Compliance   | Right to Erasure (GDPR Article 17)                      |
| **RB-038-2** | Cascade Delete    | Sử dụng FK CASCADE từ ERD                               |
| **RB-038-3** | Transaction       | Tất cả DELETE trong 1 transaction (atomicity)           |
| **RB-038-4** | Re-authentication | Yêu cầu password để xác nhận                            |
| **RB-038-5** | Audit Log         | Log deletion event (time, IP, user agent) trước khi xóa |
| **RB-038-6** | Retention (Legal) | Nếu có yêu cầu pháp lý, giữ audit log (anonymized)      |

#### Dữ liệu Đầu vào

```typescript
interface DeleteAccountInput {
  password: string; // re-authentication
  confirmation: boolean; // "I understand" checkbox
}
```

#### Dữ liệu Đầu ra

**Success (202 Accepted):**

```json
{
  "success": true,
  "message": "Tài khoản của bạn đang được xóa. Bạn sẽ nhận email xác nhận sau khi hoàn tất.",
  "logout": true
}
```

Client sẽ logout ngay lập tức.

#### API Endpoint

```
DELETE /api/account
Authorization: Bearer <access_token>
Content-Type: application/json

{
  "password": "user_password",
  "confirmation": true
}
```

#### Ưu tiên

**Must Have** (GDPR compliance)

---

## 3. YÊU CẦU PHI CHỨC NĂNG

### **NFR-001: Usability (Khả năng Sử dụng)**

#### Mã NFR

`NFR-001`

#### Yêu cầu Chi tiết

| ID             | Yêu cầu             | Tiêu chuẩn                                              |
| -------------- | ------------------- | ------------------------------------------------------- |
| **NFR-001-1**  | Mobile-first Design | UI tối ưu cho màn hình mobile (4.7" - 6.7")             |
| **NFR-001-2**  | Touch Target Size   | Tối thiểu 44x44pt (iOS HIG), 48x48dp (Android Material) |
| **NFR-001-3**  | Language            | Vietnamese UI (default), English support (optional)     |
| **NFR-001-4**  | Dynamic Type        | Hỗ trợ font scaling (iOS Dynamic Type, Android Scale)   |
| **NFR-001-5**  | Gestures            | Hỗ trợ swipe, long-press, pull-to-refresh               |
| **NFR-001-6**  | Loading States      | Skeleton screens, progress bars, spinners rõ ràng       |
| **NFR-001-7**  | Empty States        | Friendly empty state với hướng dẫn hành động            |
| **NFR-001-8**  | Error Messages      | Vietnamese, cụ thể, actionable (không technical jargon) |
| **NFR-001-9**  | Onboarding          | Tutorial/walkthrough cho users lần đầu                  |
| **NFR-001-10** | Help & Support      | In-app help, tooltips, FAQ                              |

#### Validation

- User testing với 5+ giáo viên
- SUS (System Usability Scale) score >= 70

---

### **NFR-002: Accessibility (Khả năng Tiếp cận)**

#### Mã NFR

`NFR-002`

#### Yêu cầu Chi tiết

| ID             | Yêu cầu              | Tiêu chuẩn                                                |
| -------------- | -------------------- | --------------------------------------------------------- |
| **NFR-002-1**  | WCAG Level           | WCAG 2.1 Level AA compliance                              |
| **NFR-002-2**  | Color Contrast       | Minimum 4.5:1 cho text, 3:1 cho UI components             |
| **NFR-002-3**  | Screen Reader        | VoiceOver (iOS), TalkBack (Android) support               |
| **NFR-002-4**  | Alt Text             | Tất cả images phải có meaningful alt text                 |
| **NFR-002-5**  | Form Labels          | Tất cả form controls phải có labels                       |
| **NFR-002-6**  | Keyboard Navigation  | Có thể navigate bằng keyboard (Android external keyboard) |
| **NFR-002-7**  | Focus Indicators     | Rõ ràng focus state cho interactive elements              |
| **NFR-002-8**  | Semantic HTML/Native | Sử dụng native components khi có thể                      |
| **NFR-002-9**  | Text Resize          | Hỗ trợ resize lên 200% không break layout                 |
| **NFR-002-10** | No Color-Only Info   | Không dùng màu làm thông tin duy nhất                     |

#### Validation

- Axe DevTools automated scan (0 critical issues)
- Manual testing với VoiceOver/TalkBack
- Color contrast checker

---

### **NFR-003: Performance (Hiệu năng)**

#### Mã NFR

`NFR-003`

#### Yêu cầu Chi tiết

| Metric         | Target              | Measurement |
| -------------- | ------------------- | ----------- | ----------------------- |
| **NFR-003-1**  | App Cold Start      | < 2 seconds | Time to interactive     |
| **NFR-003-2**  | App Warm Start      | < 1 second  | From background         |
| **NFR-003-3**  | Screen Transition   | < 300ms     | Navigation animation    |
| **NFR-003-4**  | API Response (GET)  | p95 < 500ms | Server response time    |
| **NFR-003-5**  | API Response (POST) | p95 < 1s    | Write operations        |
| **NFR-003-6**  | Search              | < 200ms     | Behavior/student search |
| **NFR-003-7**  | Chart Rendering     | < 500ms     | Analytics charts        |
| **NFR-003-8**  | Image Loading       | Progressive | Blur-up, lazy load      |
| **NFR-003-9**  | Video Playback      | Start < 2s  | From tap to play        |
| **NFR-003-10** | Offline Cache Load  | < 100ms     | From SQLite             |

#### Scaling Targets

| Resource             | Target                       |
| -------------------- | ---------------------------- |
| **Concurrent Users** | 500 users                    |
| **Requests/sec**     | 100 req/s                    |
| **Database**         | 100k users, 10M session logs |
| **Storage**          | 1TB media files              |

#### Validation

- Lighthouse/WebPageTest scores
- Load testing (JMeter, K6)
- Real device testing (low-end Android)

---

### **NFR-004: Reliability (Độ tin cậy)**

#### Mã NFR

`NFR-004`

#### Yêu cầu Chi tiết

| ID             | Yêu cầu               | Tiêu chuẩn                                           |
| -------------- | --------------------- | ---------------------------------------------------- |
| **NFR-004-1**  | Uptime                | >= 99.5% (service-level, ~43 minutes downtime/month) |
| **NFR-004-2**  | Scheduled Maintenance | Off-peak hours (2-4 AM Vietnam time)                 |
| **NFR-004-3**  | Error Rate            | < 0.1% requests fail                                 |
| **NFR-004-4**  | Data Durability       | 99.999999999% (11 nines - R2 guarantee)              |
| **NFR-004-5**  | Backup Frequency      | Daily automated backups (DB)                         |
| **NFR-004-6**  | Backup Retention      | 30 days rolling                                      |
| **NFR-004-7**  | Disaster Recovery     | RTO < 4 hours, RPO < 1 hour                          |
| **NFR-004-8**  | Audit Logs            | Tất cả critical operations (create/update/delete)    |
| **NFR-004-9**  | Monitoring            | Real-time alerts (Sentry, CloudWatch)                |
| **NFR-004-10** | Crash Rate            | < 1% (Firebase Crashlytics)                          |

---

### **NFR-005: Security (Bảo mật)**

#### Mã NFR

`NFR-005`

#### Yêu cầu Chi tiết

| ID             | Yêu cầu                  | Implementation                                      |
| -------------- | ------------------------ | --------------------------------------------------- |
| **NFR-005-1**  | Transport Security       | TLS 1.3 cho tất cả connections                      |
| **NFR-005-2**  | Authentication           | JWT với short-lived access tokens (1h)              |
| **NFR-005-3**  | Token Refresh            | Refresh tokens (7d) với rotation                    |
| **NFR-005-4**  | Password Hashing         | bcrypt, cost factor = 12                            |
| **NFR-005-5**  | Rate Limiting            | 5 failed logins / 15 min, 100 API calls / min       |
| **NFR-005-6**  | Input Validation         | Sanitize all inputs (SQL injection, XSS)            |
| **NFR-005-7**  | SQL Injection Prevention | Parameterized queries, ORM                          |
| **NFR-005-8**  | File Upload Security     | Type validation, size limits, virus scan (optional) |
| **NFR-005-9**  | Secure Storage (Client)  | Keychain (iOS), Keystore (Android) for tokens       |
| **NFR-005-10** | Signed URLs              | Cloudflare R2 signed URLs (TTL)                     |
| **NFR-005-11** | Audit Logs               | Login attempts, data modifications, deletions       |
| **NFR-005-12** | HTTPS Only               | No HTTP, HSTS headers                               |

---

### **NFR-006 đến NFR-010**

_(Tóm tắt - chi tiết đầy đủ trong conversation trên)_

**NFR-006: Maintainability**

- TypeScript codebase
- ESLint (Airbnb), Prettier
- Unit coverage >= 80%
- Modular components

**NFR-007: Privacy & Compliance**

- GDPR compliant (Right to Access, Erasure, Portability)
- Vietnam Decree 13/2023
- COPPA compliant
- Clear Privacy Policy

**NFR-008: Scalability**

- Horizontal scaling (containers)
- Database auto-scaling
- CDN for static assets
- Queue-based background jobs

**NFR-009: Internationalization (i18n)**

- Vietnamese (primary)
- English (secondary)
- Locale-aware date/number format

**NFR-010: Monitoring & Analytics**

- Error tracking (Sentry)
- Performance (Firebase)
- Analytics (Firebase)
- Uptime monitoring (Pingdom)

---

```

**✅ PHẦN 8 XONG - Sections 2.10 + NFRs hoàn tất**

Tiếp tục với **PHẦN 9/10: CONSTRAINTS, TRACEABILITY MATRIX & ANALYSIS**?
```
