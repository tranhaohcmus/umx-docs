# PHẦN 9/10: CONSTRAINTS, TRACEABILITY MATRIX & COMPREHENSIVE ANALYSIS

````markdown
## 4. RÀNG BUỘC DỮ LIỆU & TÍNH TOÀN VẸN

### 4.1 Ràng buộc ERD (Database Constraints)

#### 4.1.1 Primary Keys

Tất cả bảng sử dụng **UUID** làm Primary Key:

```sql
-- Ưu điểm UUID:
-- ✅ Distributed-friendly (no central ID generator)
-- ✅ Không lộ số lượng records
-- ✅ Có thể generate client-side (offline mode)
-- ✅ Merge data từ multiple sources dễ dàng

-- Example
CREATE TABLE teachers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  ...
);
```
````

#### 4.1.2 Foreign Key Constraints

Tất cả FK có **explicit naming** và **ON DELETE behavior**:

```sql
-- CASCADE: Xóa parent → tự động xóa children
ALTER TABLE students
  ADD CONSTRAINT fk_students_teacher
  FOREIGN KEY (teacher_id) REFERENCES teachers(id)
  ON DELETE CASCADE;

ALTER TABLE sessions
  ADD CONSTRAINT fk_sessions_student
  FOREIGN KEY (student_id) REFERENCES students(id)
  ON DELETE CASCADE;

-- RESTRICT: Không cho xóa parent nếu còn children
ALTER TABLE behavior_incidents
  ADD CONSTRAINT fk_incidents_behavior
  FOREIGN KEY (behavior_library_id) REFERENCES behavior_library(id)
  ON DELETE RESTRICT;
```

**CASCADE Chain (Critical!):**

```
DELETE teachers (id=T1)
  ↓ CASCADE
DELETE students (teacher_id=T1)
  ↓ CASCADE
DELETE sessions (student_id=S1)
  ↓ CASCADE
DELETE session_contents (session_id=SE1)
  ↓ CASCADE
DELETE content_goals (session_content_id=SC1)

DELETE session_logs (session_id=SE1)
  ↓ CASCADE
DELETE goal_evaluations (session_log_id=SL1)
DELETE log_media_attachments (session_log_id=SL1)
DELETE behavior_incidents (session_log_id=SL1)
```

#### 4.1.3 Unique Constraints

```sql
-- Teachers
ALTER TABLE teachers ADD CONSTRAINT uq_teachers_email UNIQUE (email);

-- Behavior Library
ALTER TABLE behavior_library ADD CONSTRAINT uq_behavior_code UNIQUE (behavior_code);

-- Session Logs (1-1 relationship)
ALTER TABLE session_logs ADD CONSTRAINT uq_session_logs_session UNIQUE (session_id);

-- Goal Evaluations (mỗi goal chỉ evaluate 1 lần trong 1 log)
ALTER TABLE goal_evaluations
  ADD CONSTRAINT uq_goal_eval_log_goal UNIQUE (session_log_id, content_goal_id);

-- Teacher Favorites
ALTER TABLE teacher_favorites
  ADD CONSTRAINT uq_favorites_teacher_behavior UNIQUE (teacher_id, behavior_library_id);

-- User Settings
ALTER TABLE user_settings
  ADD CONSTRAINT uq_settings_teacher_key UNIQUE (teacher_id, key);

-- Content Library Ratings
ALTER TABLE content_library_ratings
  ADD CONSTRAINT uq_ratings_content_teacher UNIQUE (content_library_id, teacher_id);
```

#### 4.1.4 Check Constraints

```sql
-- Enum-like constraints
ALTER TABLE students ADD CONSTRAINT chk_students_gender
  CHECK (gender IN ('male', 'female', 'other'));

ALTER TABLE students ADD CONSTRAINT chk_students_status
  CHECK (status IN ('active', 'paused', 'archived'));

ALTER TABLE sessions ADD CONSTRAINT chk_sessions_time_slot
  CHECK (time_slot IN ('morning', 'afternoon', 'evening'));

ALTER TABLE sessions ADD CONSTRAINT chk_sessions_status
  CHECK (status IN ('pending', 'completed', 'cancelled'));

ALTER TABLE sessions ADD CONSTRAINT chk_sessions_creation_method
  CHECK (creation_method IN ('manual', 'ai'));

ALTER TABLE session_contents ADD CONSTRAINT chk_contents_domain
  CHECK (domain IN ('cognitive', 'motor', 'language', 'social', 'self_care'));

ALTER TABLE content_goals ADD CONSTRAINT chk_goals_type
  CHECK (goal_type IN ('knowledge', 'skill', 'behavior'));

ALTER TABLE session_logs ADD CONSTRAINT chk_logs_mood
  CHECK (mood IN ('very_difficult', 'difficult', 'normal', 'good', 'very_good'));

ALTER TABLE goal_evaluations ADD CONSTRAINT chk_eval_status
  CHECK (status IN ('achieved', 'partially_achieved', 'not_achieved', 'not_applicable'));

ALTER TABLE goal_evaluations ADD CONSTRAINT chk_eval_support_level
  CHECK (support_level IN ('independent', 'minimal_prompt', 'moderate_prompt', 'full_prompt', 'hand_over_hand'));

ALTER TABLE log_media_attachments ADD CONSTRAINT chk_media_type
  CHECK (media_type IN ('image', 'video', 'audio'));

ALTER TABLE content_library ADD CONSTRAINT chk_library_difficulty
  CHECK (difficulty_level IN ('beginner', 'intermediate', 'advanced'));

ALTER TABLE ai_processing ADD CONSTRAINT chk_ai_status
  CHECK (processing_status IN ('pending', 'processing', 'completed', 'failed'));

-- Range constraints
ALTER TABLE session_logs ADD CONSTRAINT chk_logs_energy_level
  CHECK (energy_level BETWEEN 1 AND 5);

ALTER TABLE session_logs ADD CONSTRAINT chk_logs_cooperation_level
  CHECK (cooperation_level BETWEEN 1 AND 5);

ALTER TABLE session_logs ADD CONSTRAINT chk_logs_focus_level
  CHECK (focus_level BETWEEN 1 AND 5);

ALTER TABLE session_logs ADD CONSTRAINT chk_logs_independence_level
  CHECK (independence_level BETWEEN 1 AND 5);

ALTER TABLE session_logs ADD CONSTRAINT chk_logs_overall_rating
  CHECK (overall_rating BETWEEN 1 AND 5);

ALTER TABLE goal_evaluations ADD CONSTRAINT chk_eval_achievement_level
  CHECK (achievement_level BETWEEN 0 AND 100);

ALTER TABLE behavior_incidents ADD CONSTRAINT chk_incidents_intensity
  CHECK (intensity_level BETWEEN 1 AND 5);

ALTER TABLE content_library_ratings ADD CONSTRAINT chk_ratings_rating
  CHECK (rating BETWEEN 1 AND 5);

ALTER TABLE content_library ADD CONSTRAINT chk_library_rating_avg
  CHECK (rating_avg BETWEEN 0 AND 5);

ALTER TABLE ai_processing ADD CONSTRAINT chk_ai_progress
  CHECK (progress BETWEEN 0 AND 100);

-- Logic constraints
ALTER TABLE sessions ADD CONSTRAINT chk_sessions_time_range
  CHECK (end_time > start_time);

ALTER TABLE content_library ADD CONSTRAINT chk_library_age_range
  CHECK (target_age_max >= target_age_min);

ALTER TABLE behavior_library ADD CONSTRAINT chk_behavior_age_range
  CHECK (age_range_max >= age_range_min);
```

#### 4.1.5 Not Null Constraints

```sql
-- Critical fields phải NOT NULL
ALTER TABLE teachers ALTER COLUMN email SET NOT NULL;
ALTER TABLE teachers ALTER COLUMN password_hash SET NOT NULL;
ALTER TABLE teachers ALTER COLUMN is_verified SET NOT NULL;
ALTER TABLE teachers ALTER COLUMN is_active SET NOT NULL;

ALTER TABLE students ALTER COLUMN teacher_id SET NOT NULL;
ALTER TABLE students ALTER COLUMN first_name SET NOT NULL;
ALTER TABLE students ALTER COLUMN last_name SET NOT NULL;
ALTER TABLE students ALTER COLUMN status SET NOT NULL;

ALTER TABLE sessions ALTER COLUMN student_id SET NOT NULL;
ALTER TABLE sessions ALTER COLUMN session_date SET NOT NULL;
ALTER TABLE sessions ALTER COLUMN start_time SET NOT NULL;
ALTER TABLE sessions ALTER COLUMN end_time SET NOT NULL;
ALTER TABLE sessions ALTER COLUMN status SET NOT NULL;
ALTER TABLE sessions ALTER COLUMN creation_method SET NOT NULL;

ALTER TABLE session_contents ALTER COLUMN session_id SET NOT NULL;
ALTER TABLE session_contents ALTER COLUMN title SET NOT NULL;
ALTER TABLE session_contents ALTER COLUMN domain SET NOT NULL;

ALTER TABLE content_goals ALTER COLUMN session_content_id SET NOT NULL;
ALTER TABLE content_goals ALTER COLUMN description SET NOT NULL;
ALTER TABLE content_goals ALTER COLUMN goal_type SET NOT NULL;

ALTER TABLE session_logs ALTER COLUMN session_id SET NOT NULL;

ALTER TABLE goal_evaluations ALTER COLUMN session_log_id SET NOT NULL;
ALTER TABLE goal_evaluations ALTER COLUMN content_goal_id SET NOT NULL;

ALTER TABLE behavior_incidents ALTER COLUMN session_log_id SET NOT NULL;
ALTER TABLE behavior_incidents ALTER COLUMN antecedent SET NOT NULL;
ALTER TABLE behavior_incidents ALTER COLUMN behavior_description SET NOT NULL;
ALTER TABLE behavior_incidents ALTER COLUMN consequence SET NOT NULL;
ALTER TABLE behavior_incidents ALTER COLUMN intensity_level SET NOT NULL;
```

### 4.2 Indexes (Performance Optimization)

#### 4.2.1 Primary & Foreign Key Indexes (Auto-created)

```sql
-- PostgreSQL tự động tạo index cho:
-- - All PRIMARY KEY columns
-- - All UNIQUE constraints
-- - (Optional) FOREIGN KEY columns (best practice: create explicitly)
```

#### 4.2.2 Foreign Key Indexes (Explicit)

```sql
-- Tối ưu JOIN operations
CREATE INDEX idx_students_teacher_id ON students(teacher_id);
CREATE INDEX idx_sessions_student_id ON sessions(student_id);
CREATE INDEX idx_session_contents_session_id ON session_contents(session_id);
CREATE INDEX idx_content_goals_session_content_id ON content_goals(session_content_id);
CREATE INDEX idx_session_logs_session_id ON session_logs(session_id);
CREATE INDEX idx_goal_evaluations_session_log_id ON goal_evaluations(session_log_id);
CREATE INDEX idx_goal_evaluations_content_goal_id ON goal_evaluations(content_goal_id);
CREATE INDEX idx_log_media_session_log_id ON log_media_attachments(session_log_id);
CREATE INDEX idx_behavior_incidents_session_log_id ON behavior_incidents(session_log_id);
CREATE INDEX idx_behavior_incidents_behavior_id ON behavior_incidents(behavior_library_id);
CREATE INDEX idx_behavior_library_group_id ON behavior_library(behavior_group_id);
CREATE INDEX idx_teacher_favorites_teacher_id ON teacher_favorites(teacher_id);
CREATE INDEX idx_teacher_favorites_behavior_id ON teacher_favorites(behavior_library_id);
CREATE INDEX idx_content_library_teacher_id ON content_library(teacher_id);
CREATE INDEX idx_content_ratings_content_id ON content_library_ratings(content_library_id);
CREATE INDEX idx_content_ratings_teacher_id ON content_library_ratings(teacher_id);
CREATE INDEX idx_user_settings_teacher_id ON user_settings(teacher_id);
CREATE INDEX idx_backup_history_teacher_id ON backup_history(teacher_id);
CREATE INDEX idx_ai_processing_teacher_id ON ai_processing(teacher_id);
```

#### 4.2.3 Composite Indexes (Multi-column)

```sql
-- Tối ưu cho common queries với multiple filters
CREATE INDEX idx_sessions_student_date ON sessions(student_id, session_date);
CREATE INDEX idx_sessions_teacher_date ON sessions(created_by, session_date);
CREATE INDEX idx_sessions_student_status ON sessions(student_id, status)
  WHERE deleted_at IS NULL;

CREATE INDEX idx_students_teacher_active ON students(teacher_id, status)
  WHERE deleted_at IS NULL;

CREATE INDEX idx_behavior_library_search ON behavior_library(behavior_group_id, is_active);

CREATE INDEX idx_content_library_search ON content_library(teacher_id, domain, is_public)
  WHERE deleted_at IS NULL;
```

#### 4.2.4 Partial Indexes (Filtered)

```sql
-- Chỉ index records quan trọng (giảm index size)
CREATE INDEX idx_sessions_active ON sessions(session_date)
  WHERE deleted_at IS NULL AND status != 'cancelled';

CREATE INDEX idx_students_active ON students(teacher_id)
  WHERE deleted_at IS NULL AND status = 'active';

CREATE INDEX idx_behavior_library_active ON behavior_library(name_vn)
  WHERE is_active = TRUE;
```

#### 4.2.5 Full-Text Search Indexes (GIN)

```sql
-- JSONB search
CREATE INDEX idx_behavior_keywords_gin ON behavior_library USING GIN (keywords_vn);
CREATE INDEX idx_behavior_keywords_en_gin ON behavior_library USING GIN (keywords_en);
CREATE INDEX idx_content_tags_gin ON content_library USING GIN (tags);

-- JSON fields
CREATE INDEX idx_behavior_explanation_gin ON behavior_library USING GIN (explanation);
CREATE INDEX idx_behavior_solutions_gin ON behavior_library USING GIN (solutions);
```

#### 4.2.6 Ordering/Sorting Indexes

```sql
-- Tối ưu cho ORDER BY queries
CREATE INDEX idx_sessions_date_desc ON sessions(session_date DESC);
CREATE INDEX idx_behavior_usage_desc ON behavior_library(usage_count DESC);
CREATE INDEX idx_behavior_last_used_desc ON behavior_library(last_used_at DESC NULLS LAST);
CREATE INDEX idx_content_library_rating_desc ON content_library(rating_avg DESC, usage_count DESC);
```

### 4.3 Triggers & Computed Fields

#### 4.3.1 Auto-update Timestamps

```sql
-- Trigger function
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Apply to all tables with updated_at
CREATE TRIGGER trigger_teachers_updated_at
  BEFORE UPDATE ON teachers
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- Repeat for: students, sessions, session_contents, content_goals,
-- session_logs, goal_evaluations, behavior_library, content_library, etc.
```

#### 4.3.2 Auto-increment Usage Count

```sql
-- Khi behavior được sử dụng trong incident
CREATE OR REPLACE FUNCTION increment_behavior_usage()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE behavior_library
  SET
    usage_count = usage_count + 1,
    last_used_at = NOW()
  WHERE id = NEW.behavior_library_id;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_increment_behavior_usage
  AFTER INSERT ON behavior_incidents
  FOR EACH ROW
  WHEN (NEW.behavior_library_id IS NOT NULL)
  EXECUTE FUNCTION increment_behavior_usage();
```

#### 4.3.3 Auto-update Session Status

```sql
-- Khi session_logs được tạo → update session.status = 'completed'
CREATE OR REPLACE FUNCTION mark_session_completed()
RETURNS TRIGGER AS $$
BEGIN
  UPDATE sessions
  SET
    status = 'completed',
    has_evaluation = TRUE,
    updated_at = NOW()
  WHERE id = NEW.session_id;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_mark_session_completed
  AFTER INSERT ON session_logs
  FOR EACH ROW EXECUTE FUNCTION mark_session_completed();
```

#### 4.3.4 Auto-calculate Content Library Rating

```sql
-- Khi rating mới được insert/update/delete → recalculate avg
CREATE OR REPLACE FUNCTION recalculate_content_rating()
RETURNS TRIGGER AS $$
DECLARE
  content_id UUID;
BEGIN
  IF TG_OP = 'DELETE' THEN
    content_id := OLD.content_library_id;
  ELSE
    content_id := NEW.content_library_id;
  END IF;

  UPDATE content_library
  SET
    rating_avg = (
      SELECT COALESCE(AVG(rating), 0)::DECIMAL(3,2)
      FROM content_library_ratings
      WHERE content_library_id = content_id
    ),
    rating_count = (
      SELECT COUNT(*)
      FROM content_library_ratings
      WHERE content_library_id = content_id
    )
  WHERE id = content_id;

  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_recalculate_content_rating
  AFTER INSERT OR UPDATE OR DELETE ON content_library_ratings
  FOR EACH ROW EXECUTE FUNCTION recalculate_content_rating();
```

#### 4.3.5 Auto-increment Content Library Usage

```sql
CREATE OR REPLACE FUNCTION increment_content_usage()
RETURNS TRIGGER AS $$
BEGIN
  IF NEW.content_library_id IS NOT NULL THEN
    UPDATE content_library
    SET
      usage_count = usage_count + 1,
      last_used_at = NOW()
    WHERE id = NEW.content_library_id;
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_increment_content_usage
  AFTER INSERT ON session_contents
  FOR EACH ROW EXECUTE FUNCTION increment_content_usage();
```

### 4.4 Data Validation Rules (Application-Level)

```typescript
// Example validation schemas (using Zod)

const StudentSchema = z.object({
  first_name: z.string().min(1).max(100),
  last_name: z.string().min(1).max(100),
  nickname: z.string().max(50).optional(),
  date_of_birth: z.date().refine(
    (date) => {
      const age = differenceInYears(new Date(), date);
      return age >= 2 && age <= 18;
    },
    { message: "Age must be between 2-18 years" }
  ),
  gender: z.enum(["male", "female", "other"]),
  status: z.enum(["active", "paused", "archived"]).default("active"),
  diagnosis: z.string().max(1000).optional(),
  notes: z.string().max(2000).optional(),
});

const SessionSchema = z.object({
  student_id: z.string().uuid(),
  session_date: z.date().refine((date) => {
    const sixMonthsAgo = subMonths(new Date(), 6);
    const oneYearLater = addYears(new Date(), 1);
    return date >= sixMonthsAgo && date <= oneYearLater;
  }),
  time_slot: z.enum(["morning", "afternoon", "evening"]),
  start_time: z.string().regex(/^([01]\d|2[0-3]):([0-5]\d):([0-5]\d)$/),
  end_time: z
    .string()
    .regex(/^([01]\d|2[0-3]):([0-5]\d):([0-5]\d)$/)
    .refine((end, ctx) => end > ctx.parent.start_time),
  duration_minutes: z.number().min(30),
});

const BehaviorIncidentSchema = z.object({
  session_log_id: z.string().uuid(),
  behavior_library_id: z.string().uuid().optional(),
  antecedent: z.string().min(10).max(1000),
  behavior_description: z.string().min(10).max(1000),
  consequence: z.string().min(10).max(1000),
  intensity_level: z.number().min(1).max(5),
});
```

---

## 5. MA TRẬN TRUY XUẤT (Traceability Matrix)

### 5.1 Mapping: Functional Requirements → ERD Entities

| FR ID      | Chức năng                | ERD Entities                                                      | Relationships                                        |
| ---------- | ------------------------ | ----------------------------------------------------------------- | ---------------------------------------------------- |
| **FR-001** | Đăng ký giáo viên        | TEACHERS                                                          | -                                                    |
| **FR-002** | Xác thực email           | TEACHERS                                                          | -                                                    |
| **FR-003** | Đăng nhập                | TEACHERS                                                          | -                                                    |
| **FR-004** | Refresh token            | TEACHERS                                                          | -                                                    |
| **FR-005** | Đăng xuất                | TEACHERS                                                          | -                                                    |
| **FR-006** | Biometric login          | TEACHERS, USER_SETTINGS                                           | TEACHERS ← USER_SETTINGS                             |
| **FR-007** | Tạo học sinh             | STUDENTS                                                          | TEACHERS ← STUDENTS                                  |
| **FR-008** | Danh sách học sinh       | STUDENTS                                                          | TEACHERS ← STUDENTS                                  |
| **FR-009** | Chi tiết học sinh        | STUDENTS, SESSIONS                                                | STUDENTS ← SESSIONS                                  |
| **FR-010** | Cập nhật học sinh        | STUDENTS                                                          | -                                                    |
| **FR-011** | Xóa học sinh             | STUDENTS, SESSIONS                                                | CASCADE delete                                       |
| **FR-012** | Thay đổi status học sinh | STUDENTS                                                          | -                                                    |
| **FR-013** | Tạo session - Step 1     | SESSIONS                                                          | STUDENTS ← SESSIONS                                  |
| **FR-014** | Tạo session - Step 2     | SESSION_CONTENTS, CONTENT_GOALS, CONTENT_LIBRARY                  | SESSIONS ← SESSION_CONTENTS ← CONTENT_GOALS          |
| **FR-015** | Tạo session - Step 3     | SESSIONS                                                          | -                                                    |
| **FR-016** | Danh sách sessions       | SESSIONS, STUDENTS, SESSION_CONTENTS, CONTENT_GOALS, SESSION_LOGS | Multiple JOINs                                       |
| **FR-017** | Chi tiết session         | SESSIONS, SESSION_CONTENTS, CONTENT_GOALS, SESSION_LOGS           | Multiple JOINs                                       |
| **FR-018** | Ghi nhật ký - Step 1     | SESSION_LOGS, GOAL_EVALUATIONS, CONTENT_GOALS                     | SESSIONS ← SESSION_LOGS ← GOAL_EVALUATIONS           |
| **FR-019** | Ghi nhật ký - Step 2     | SESSION_LOGS                                                      | -                                                    |
| **FR-020** | Ghi nhật ký - Step 3     | SESSION_LOGS, LOG_MEDIA_ATTACHMENTS                               | SESSION_LOGS ← LOG_MEDIA_ATTACHMENTS                 |
| **FR-021** | Ghi nhật ký - Step 4     | BEHAVIOR_INCIDENTS, BEHAVIOR_LIBRARY                              | SESSION_LOGS ← BEHAVIOR_INCIDENTS → BEHAVIOR_LIBRARY |
| **FR-022** | Hoàn tất nhật ký         | SESSION_LOGS, SESSIONS                                            | Update statuses                                      |
| **FR-023** | Xem thư viện hành vi     | BEHAVIOR_LIBRARY, BEHAVIOR_GROUPS, TEACHER_FAVORITES              | BEHAVIOR_GROUPS ← BEHAVIOR_LIBRARY, N-M junction     |
| **FR-024** | Chi tiết hành vi         | BEHAVIOR_LIBRARY, BEHAVIOR_GROUPS                                 | BEHAVIOR_GROUPS ← BEHAVIOR_LIBRARY                   |
| **FR-025** | Toggle favorite hành vi  | TEACHER_FAVORITES                                                 | TEACHERS ←→ BEHAVIOR_LIBRARY (N-M)                   |
| **FR-026** | Tạo content template     | CONTENT_LIBRARY                                                   | TEACHERS ← CONTENT_LIBRARY                           |
| **FR-027** | Đánh giá template        | CONTENT_LIBRARY_RATINGS, CONTENT_LIBRARY                          | N-M, trigger update                                  |
| **FR-028** | Upload AI processing     | AI_PROCESSING                                                     | TEACHERS ← AI_PROCESSING                             |
| **FR-029** | AI processing job        | AI_PROCESSING                                                     | Background update                                    |
| **FR-030** | Tạo sessions từ AI       | SESSIONS, SESSION_CONTENTS, CONTENT_GOALS, AI_PROCESSING          | Bulk insert                                          |
| **FR-031** | Analytics dashboard      | All tables                                                        | Complex aggregations & JOINs                         |
| **FR-032** | Export reports           | All tables                                                        | Read-only queries                                    |
| **FR-033** | Offline cache sync       | All tables                                                        | Read for local SQLite                                |
| **FR-034** | Offline read-only        | Local SQLite                                                      | N/A (client-side)                                    |
| **FR-035** | Offline queue sync       | All tables                                                        | Deferred writes                                      |
| **FR-036** | User settings            | TEACHERS, USER_SETTINGS                                           | TEACHERS ← USER_SETTINGS                             |
| **FR-037** | Backup & export          | All tables                                                        | Full data export                                     |
| **FR-038** | Delete account           | All tables                                                        | CASCADE delete entire tree                           |

### 5.2 Mapping: ERD Entities → API Endpoints

| Entity                      | Create                                  | Read (List)                            | Read (Detail)                  | Update                                   | Delete                                  |
| --------------------------- | --------------------------------------- | -------------------------------------- | ------------------------------ | ---------------------------------------- | --------------------------------------- |
| **TEACHERS**                | `POST /auth/register`                   | -                                      | `GET /api/teachers/me`         | `PATCH /api/teachers/me`                 | `DELETE /api/account`                   |
| **STUDENTS**                | `POST /api/students`                    | `GET /api/students`                    | `GET /api/students/:id`        | `PATCH /api/students/:id`                | `DELETE /api/students/:id`              |
| **SESSIONS**                | `POST /api/sessions`                    | `GET /api/sessions`                    | `GET /api/sessions/:id`        | `PATCH /api/sessions/:id`                | `DELETE /api/sessions/:id`              |
| **SESSION_CONTENTS**        | `POST /api/sessions/:id/contents`       | -                                      | -                              | `PATCH /api/session-contents/:id`        | `DELETE /api/session-contents/:id`      |
| **CONTENT_GOALS**           | (Nested in contents)                    | -                                      | -                              | `PATCH /api/content-goals/:id`           | `DELETE /api/content-goals/:id`         |
| **SESSION_LOGS**            | `POST /api/sessions/:id/logs`           | -                                      | `GET /api/session-logs/:id`    | `PUT /api/session-logs/:id/*`            | -                                       |
| **GOAL_EVALUATIONS**        | `PUT /api/session-logs/:id/goals`       | -                                      | -                              | `PUT /api/session-logs/:id/goals`        | -                                       |
| **LOG_MEDIA_ATTACHMENTS**   | `POST /api/media/upload`                | -                                      | -                              | -                                        | `DELETE /api/media/:id`                 |
| **BEHAVIOR_GROUPS**         | (System data)                           | `GET /api/behavior-groups`             | -                              | -                                        | -                                       |
| **BEHAVIOR_LIBRARY**        | (System data)                           | `GET /api/behaviors`                   | `GET /api/behaviors/:id`       | -                                        | -                                       |
| **BEHAVIOR_INCIDENTS**      | `POST /api/behavior-incidents`          | -                                      | -                              | `PATCH /api/behavior-incidents/:id`      | `DELETE /api/behavior-incidents/:id`    |
| **TEACHER_FAVORITES**       | `POST /api/teachers/me/favorites`       | `GET /api/teachers/me/favorites`       | -                              | -                                        | `DELETE /api/teachers/me/favorites/:id` |
| **CONTENT_LIBRARY**         | `POST /api/content-library`             | `GET /api/content-library`             | `GET /api/content-library/:id` | `PATCH /api/content-library/:id`         | `DELETE /api/content-library/:id`       |
| **CONTENT_LIBRARY_RATINGS** | `POST /api/content-library/:id/ratings` | `GET /api/content-library/:id/ratings` | -                              | `PATCH /api/content-library/:id/ratings` | -                                       |
| **USER_SETTINGS**           | `POST /api/settings`                    | `GET /api/settings`                    | -                              | `PATCH /api/settings`                    | -                                       |
| **BACKUP_HISTORY**          | `POST /api/backups`                     | `GET /api/backups`                     | `GET /api/backups/:id`         | -                                        | -                                       |
| **AI_PROCESSING**           | `POST /api/ai/process`                  | `GET /api/ai/process`                  | `GET /api/ai/process/:id`      | -                                        | -                                       |

### 5.3 Complete API Endpoints Summary

#### Authentication & User Management (6 endpoints)

```
POST   /auth/register
GET    /auth/verify-email?token=<jwt>
POST   /auth/login
POST   /auth/refresh
POST   /auth/logout
POST   /auth/forgot-password
POST   /auth/reset-password
GET    /api/teachers/me
PATCH  /api/teachers/me
DELETE /api/account
```

#### Students (6 endpoints)

```
POST   /api/students
GET    /api/students
GET    /api/students/:id
PATCH  /api/students/:id
DELETE /api/students/:id
PATCH  /api/students/:id/status
```

#### Sessions (10 endpoints)

```
POST   /api/sessions
GET    /api/sessions
GET    /api/sessions/:id
PATCH  /api/sessions/:id
DELETE /api/sessions/:id
POST   /api/sessions/:id/confirm
POST   /api/sessions/:id/cancel
POST   /api/sessions/:id/contents
POST   /api/sessions/:id/contents/from-template
PATCH  /api/sessions/:id/contents/reorder
```

#### Session Contents & Goals (4 endpoints)

```
PATCH  /api/session-contents/:id
DELETE /api/session-contents/:id
PATCH  /api/content-goals/:id
DELETE /api/content-goals/:id
```

#### Session Logs (6 endpoints)

```
POST   /api/sessions/:id/logs
GET    /api/session-logs/:id
PUT    /api/session-logs/:id/goals
PUT    /api/session-logs/:id/attitude
PUT    /api/session-logs/:id/notes
POST   /api/session-logs/:id/complete
```

#### Media (4 endpoints)

```
POST   /api/media/upload-url
POST   /api/media/:id/confirm
DELETE /api/media/:id
GET    /api/media/:id
```

#### Behaviors (8 endpoints)

```
GET    /api/behavior-groups
GET    /api/behaviors
GET    /api/behaviors/:id
POST   /api/behavior-incidents
PATCH  /api/behavior-incidents/:id
DELETE /api/behavior-incidents/:id
POST   /api/teachers/me/favorites
DELETE /api/teachers/me/favorites/:id
GET    /api/teachers/me/favorites
```

#### Content Library (9 endpoints)

```
POST   /api/content-library
GET    /api/content-library
GET    /api/content-library/:id
PATCH  /api/content-library/:id
DELETE /api/content-library/:id
POST   /api/content-library/:id/ratings
GET    /api/content-library/:id/ratings
PATCH  /api/content-library/:id/ratings
DELETE /api/content-library/:id/ratings
```

#### AI Processing (5 endpoints)

```
POST   /api/ai/process
GET    /api/ai/process/:id
GET    /api/ai/process/:id/status
POST   /api/ai/process/:id/create-sessions
DELETE /api/ai/process/:id
```

#### Analytics & Reports (5 endpoints)

```
GET    /api/analytics/overview
GET    /api/analytics/student/:id
POST   /api/reports
GET    /api/reports/:id
GET    /api/reports/:id/download
```

#### Settings & Sync (5 endpoints)

```
GET    /api/settings
PATCH  /api/settings
GET    /api/sync/metadata
GET    /api/sync/data
POST   /api/sync/upload
```

#### Backups (4 endpoints)

```
POST   /api/backups
GET    /api/backups
GET    /api/backups/:id
GET    /api/backups/:id/download
```

**Total Endpoints: 82**

---

```

**✅ PHẦN 9 XONG - Constraints + Traceability Matrix hoàn tất**

Tiếp tục với **PHẦN 10/10 (CUỐI CÙNG): APPENDIX, CONFLICT ANALYSIS, ROADMAP & CONCLUSION**?
```
